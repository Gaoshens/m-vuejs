{"version":3,"file":"reactivity.global.js","sources":["../src/effect.ts","../src/reactive.ts","../../shared/src/index.ts"],"sourcesContent":["import { Target } from './reactive';\n\ntype Fn = (...args: any[]) => any;\ntype Dep = Set<ReactiveEffect>;\n\n// 全局的effect类\nlet activeEffect: ReactiveEffect | null;\n\nclass ReactiveEffect {\n  private active = true; // 是否未激活状态\n  deps: Dep[] = [];\n  constructor(public fn: Fn) {}\n  run() {\n    // 非激活状态,直接调用effect的回调函数,返回结果\n    if (!this.active) {\n      return this.fn();\n    }\n    try {\n      cleanupEffect(this);\n      // 将当前的effect保存到全局\n      activeEffect = this;\n      // 执行effect传入的回调函数\n      // 在执行回调函数前已经将当前的effect类保存到了全局\n      // 此时调用回调函数会访问了proxy对象的属性,会触发get方法,在get方法内可以拿到当前effect类(activeEffect)\n      return this.fn();\n    } finally {\n      // 执行完毕清除全局的effect类\n      activeEffect = null;\n    }\n  }\n}\n\nexport function effect(fn: Fn) {\n  const effect = createReactiveEffect(fn);\n  effect.run();\n}\n\nfunction createReactiveEffect(fn: Fn) {\n  const effect = new ReactiveEffect(fn);\n  return effect;\n}\n\nconst targetWeakMap = new WeakMap<Target, Map<string | symbol, Dep>>();\n\nexport function track(target: Target, key: string | symbol) {\n  // 从WeakMap中取Map\n  let map = targetWeakMap.get(target);\n  // 取不到则表示第一次访问 初始化target和空的Map\n  if (!map) targetWeakMap.set(target, (map = new Map()));\n  // 从map中取Dep\n  let dep = map.get(key);\n  // 取不到表示第一次访问 初始化key和空的Dep\n  if (!dep) map.set(key, (dep = new Set()));\n\n  // 将全局的activeEffect存到Set中\n  trackEffect(dep);\n}\n\nexport function trackEffect(dep: Dep) {\n  if (!activeEffect) return;\n  dep.add(activeEffect);\n  activeEffect.deps.push(dep);\n}\n\nexport function trigger(target: Target, key: string | symbol) {\n  // 从WeakMap中取Map\n  const map = targetWeakMap.get(target);\n  // 找不到说明没有依赖收集 直接退出\n  if (!map) return;\n  // 从Map中通过key访问Dep\n  const dep = map.get(key);\n  triggerEffect(dep);\n}\n\nexport function triggerEffect(dep: Dep) {\n  if (!dep || !dep.size) return;\n  const effectTorun = new Set<ReactiveEffect>();\n  dep.forEach(effectFn => {\n    if (activeEffect !== effectFn) effectTorun.add(effectFn);\n  });\n\n  if (effectTorun && effectTorun.size) {\n    effectTorun.forEach(effectFn => {\n      effectFn.run();\n    });\n  }\n}\n// 分支切换\nfunction cleanupEffect(effect: ReactiveEffect) {\n  for (let i = 0; i < effect.deps.length; i++) {\n    effect.deps[i].delete(effect);\n  }\n  effect.deps.length = 0;\n}\n","import { isObject } from '@/shared';\nimport { track, trigger } from './effect';\n\nexport interface Target {\n  [key: string]: any;\n  [ReactiveFlags.IS_REACTIVE]?: boolean;\n}\n\nexport const enum ReactiveFlags {\n  IS_REACTIVE = '__v_isReactive',\n}\n\nconst reactiveMap = new WeakMap<Target, any>();\n\nconst mutableHandlers: ProxyHandler<object> = {\n  get(target, key, receiver) {\n    if (key === ReactiveFlags.IS_REACTIVE) return true;\n    // 收集依赖\n    track(target, key);\n    return Reflect.get(target, key, receiver);\n  },\n  set(target, key, value, receiver) {\n    const oldValue = target[key];\n    const result = Reflect.set(target, key, value, receiver);\n    // 触发依赖\n    if (oldValue !== value) {\n      trigger(target, key);\n    }\n    return result;\n  },\n};\n\nexport function reactive<T extends object>(target: T): T {\n  // 传入的target必须是对象类型\n  if (!isObject(target)) {\n    return target;\n  }\n  return createReactiveObject(target, mutableHandlers);\n}\n\n// 将对象类型的数据转换为响应式数据 target => Proxy\nfunction createReactiveObject(target: Target, handler: ProxyHandler<any>) {\n  // 传入的target已经是响应式数据 则直接返回\n  if (target[ReactiveFlags.IS_REACTIVE]) return target;\n  // 防止target被重复代理\n  if (reactiveMap.has(target)) return reactiveMap.get(target);\n\n  const proxy = new Proxy(target, handler);\n  reactiveMap.set(target, proxy);\n  return proxy;\n}\n","export function isObject(v): v is Object {\n  return typeof v === 'object' && v !== null;\n}\n\nexport function isPlainObject(v): v is Record<string | symbol, any> {\n  return Object.prototype.toString.call(v) === '[object Object]';\n}\n"],"names":["activeEffect","ReactiveEffect","constructor","fn","this","active","deps","run","effect","i","length","delete","cleanupEffect","targetWeakMap","WeakMap","track","target","key","map","get","set","Map","dep","Set","add","push","trackEffect","trigger","size","effectTorun","forEach","effectFn","triggerEffect","reactiveMap","mutableHandlers","receiver","Reflect","value","oldValue","result","createReactiveEffect","v","handler","has","proxy","Proxy","createReactiveObject"],"mappings":"wCAMA,IAAIA,EAEJ,MAAMC,EAGJC,YAAmBC,GAAAC,KAAED,GAAFA,EAFXC,KAAAC,QAAS,EACjBD,KAAIE,KAAU,EACe,CAC7BC,MAEE,IAAKH,KAAKC,OACR,OAAOD,KAAKD,KAEd,IAOE,OAgEN,SAAuBK,GACrB,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAOF,KAAKI,OAAQD,IACtCD,EAAOF,KAAKG,GAAGE,OAAOH,GAExBA,EAAOF,KAAKI,OAAS,CACvB,CA3EME,CAAcR,MAEdJ,EAAeI,KAIRA,KAAKD,IACb,CAAS,QAERH,EAAe,IAChB,CACF,EAaH,MAAMa,EAAgB,IAAIC,QAEV,SAAAC,EAAMC,EAAgBC,GAEpC,IAAIC,EAAML,EAAcM,IAAIH,GAEvBE,GAAKL,EAAcO,IAAIJ,EAASE,EAAM,IAAIG,KAE/C,IAAIC,EAAMJ,EAAIC,IAAIF,GAEbK,GAAKJ,EAAIE,IAAIH,EAAMK,EAAM,IAAIC,KAM9B,SAAsBD,GAC1B,IAAKtB,EAAc,OACnBsB,EAAIE,IAAIxB,GACRA,EAAaM,KAAKmB,KAAKH,EACzB,CAPEI,CAAYJ,EACd,CAQgB,SAAAK,EAAQX,EAAgBC,GAEtC,MAAMC,EAAML,EAAcM,IAAIH,GAE9B,IAAKE,EAAK,QAMN,SAAwBI,GAC5B,IAAKA,IAAQA,EAAIM,KAAM,OACvB,MAAMC,EAAc,IAAIN,IACxBD,EAAIQ,SAAQC,IACN/B,IAAiB+B,GAAUF,EAAYL,IAAIO,EAAS,IAGtDF,GAAeA,EAAYD,MAC7BC,EAAYC,SAAQC,IAClBA,EAASxB,KAAK,GAGpB,CAfEyB,CADYd,EAAIC,IAAIF,GAEtB,CC5DA,MAAMgB,EAAc,IAAInB,QAElBoB,EAAwC,CAC5Cf,IAAG,CAACH,EAAQC,EAAKkB,IACsB,mBAAjClB,IAEJF,EAAMC,EAAQC,GACPmB,QAAQjB,IAAIH,EAAQC,EAAKkB,IAElCf,IAAIJ,EAAQC,EAAKoB,EAAOF,GACtB,MAAMG,EAAWtB,EAAOC,GAClBsB,EAASH,QAAQhB,IAAIJ,EAAQC,EAAKoB,EAAOF,GAK/C,OAHIG,IAAaD,GACfV,EAAQX,EAAQC,GAEXsB,CACR,mBDGG,SAAiBpC,GACrB,MAAMK,EAIR,SAA8BL,GAC5B,MAAMK,EAAS,IAAIP,EAAeE,GAClC,OAAOK,CACT,CAPiBgC,CAAqBrC,GACpCK,EAAOD,KACT,aCHM,SAAqCS,GAEzC,MCjCoB,iBADGyB,EDkCTzB,ICjCwB,OAANyB,EDkCvBzB,EAMX,SAA8BA,EAAgB0B,GAE5C,GAAI1B,EAAiC,eAAE,OAAOA,EAE9C,GAAIiB,EAAYU,IAAI3B,GAAS,OAAOiB,EAAYd,IAAIH,GAEpD,MAAM4B,EAAQ,IAAIC,MAAM7B,EAAQ0B,GAEhC,OADAT,EAAYb,IAAIJ,EAAQ4B,GACjBA,CACT,CAbSE,CAAqB9B,EAAQkB,GCrChC,IAAmBO,CDsCzB"}